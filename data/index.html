<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cronotermostato - Storico</title>
    <script>
        // Carica Chart.js con fallback: CDN ‚Üí locale
        (function() {
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js';
            script.onerror = function() {
                console.log('CDN non disponibile, carico Chart.js locale');
                const localScript = document.createElement('script');
                localScript.src = '/chart.min.js';
                document.head.appendChild(localScript);
            };
            document.head.appendChild(script);
        })();

        // Carica plugin zoom per Chart.js con fallback: CDN ‚Üí locale
        (function() {
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js';
            script.onerror = function() {
                console.log('CDN zoom plugin non disponibile, carico versione locale');
                const localScript = document.createElement('script');
                localScript.src = '/chartjs-plugin-zoom.min.js';
                document.head.appendChild(localScript);
            };
            document.head.appendChild(script);
        })();
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 30px;
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
        }

        .date-selector {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        label {
            font-weight: 600;
            color: #555;
        }

        input[type="date"], select {
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        input[type="date"]:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            padding: 10px 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .chart-container {
            position: relative;
            height: 500px;
            margin-bottom: 20px;
        }

        /* --- STILE PER LA LEGENDA FISSA --- */
        #chart-tooltip {
            position: absolute;
            top: 10px;
            right: 50px; /* Spostato leggermente a sinistra per non coprire assi */
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #ddd;
            padding: 12px;
            border-radius: 8px;
            pointer-events: none; /* Permette click attraverso il box */
            font-size: 0.9em;
            color: #333;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 10;
            min-width: 160px;
        }

        .tooltip-header {
            font-weight: bold;
            margin-bottom: 8px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
            text-align: center;
            color: #555;
        }

        .tooltip-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 4px;
            font-family: monospace; /* Allinea meglio i numeri */
            font-size: 1.1em;
        }

        .tooltip-color {
            display: inline-block;
            width: 10px;
            height: 10px;
            margin-right: 8px;
            border-radius: 50%;
        }
        /* --------------------------------- */

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 25px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card h3 {
            color: #555;
            font-size: 0.9em;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
            color: #333;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 1.2em;
        }
        
        .simulation-notice {
            background: #fff3cd;
            color: #856404;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 15px;
            border: 1px solid #ffeeba;
            font-size: 0.9em;
        }

        .error {
            background: #fee;
            border: 2px solid #f88;
            color: #c33;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 1.8em;
            }

            .chart-container {
                height: 350px;
            }

            .controls {
                flex-direction: column;
            }
            
            #chart-tooltip {
                position: static; /* Su mobile mettilo sotto o sopra */
                margin-bottom: 10px;
                text-align: center;
                width: 100%;
                opacity: 1; /* Sempre visibile su mobile se ci sono dati */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Cronotermostato</h1>
        <p class="subtitle">Storico: Temperature e Umidit√†</p>

        <div class="controls">
            <div class="date-selector">
                <label for="logDate">Data:</label>
                <input type="date" id="logDate" value="">
            </div>
            <button onclick="loadLogData()">Carica Dati</button>
            <button onclick="resetZoom()">üîç Reset Zoom</button>
            <button onclick="goToUpdate()">‚öôÔ∏è Aggiornamento OTA</button>
        </div>
        
        <div id="simulationNotice" class="simulation-notice" style="display:none;">
            ‚ö†Ô∏è Modalit√† Anteprima: Impossibile contattare il dispositivo. Vengono mostrati dati simulati.
        </div>

        <div id="loading" class="loading" style="display:none;">
            Caricamento dati in corso...
        </div>

        <div id="error" class="error" style="display:none;"></div>

        <div class="chart-container" id="chartContainer">
            <canvas id="temperatureChart"></canvas>
            <!-- DIV per la legenda fissa -->
            <div id="chart-tooltip"></div>
        </div>

        <p style="text-align: center; color: #888; font-size: 0.9em; margin: 10px 0;">
            üí° Rotella per zoom | Trascina per zoom area | Shift+Trascina per pan
        </p>

        <div class="stats" id="stats"></div>
    </div>

    <script>
        let chart = null;

        // Imposta data di oggi
        document.getElementById('logDate').valueAsDate = new Date();

        // Funzione per navigare alla pagina update
        function goToUpdate() {
            window.location.href = '/update';
        }

        // Funzione per resettare lo zoom del grafico
        function resetZoom() {
            if (chart) {
                chart.resetZoom();
            }
        }

        // Carica dati automaticamente all'avvio
        window.addEventListener('load', () => {
            loadLogData();
        });

        async function loadLogData() {
            const dateInput = document.getElementById('logDate');
            const date = dateInput.value.replace(/-/g, ''); // YYYYMMDD

            // Mostra loading
            document.getElementById('loading').style.display = 'block';
            document.getElementById('error').style.display = 'none';
            document.getElementById('simulationNotice').style.display = 'none';
            document.getElementById('stats').innerHTML = '';
            
            // Pulisce tooltip precedente
            document.getElementById('chart-tooltip').style.opacity = 0;

            let arrayBuffer = null;

            try {
                // Tenta di scaricare i dati reali
                // Controllo preventivo: se siamo in blob:// (anteprima), fetch fallirebbe sicuramente
                if (window.location.protocol === 'blob:' || window.location.hostname === '') {
                    throw new Error("Ambiente di anteprima rilevato");
                }

                const response = await fetch(`/api/log/raw?date=${date}`);
                if (!response.ok) {
                    throw new Error(`Errore HTTP: ${response.status}`);
                }
                arrayBuffer = await response.arrayBuffer();

            } catch (error) {
                console.warn('Fetch fallito (normale in anteprima), uso dati simulati:', error);
                // In caso di errore (es. siamo in anteprima), generiamo dati finti
                arrayBuffer = generateMockLog(date);
                document.getElementById('simulationNotice').style.display = 'block';
            }

            try {
                // Leggi dati binari (reali o simulati)
                const data = parseBinaryLog(arrayBuffer);

                // Nascondi loading
                document.getElementById('loading').style.display = 'none';

                // Processa dati
                processData(data);

            } catch (error) {
                console.error('Errore parsing dati:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').textContent =
                    'Errore durante il caricamento dei dati: ' + error.message;
                document.getElementById('error').style.display = 'block';
            }
        }

        // Genera un ArrayBuffer finto compatibile con il formato TLOG
        function generateMockLog(dateStr) {
            const year = parseInt(dateStr.substring(0, 4)) || 2025;
            const month = parseInt(dateStr.substring(4, 6)) || 1;
            const day = parseInt(dateStr.substring(6, 8)) || 1;
            
            // Genera 1 campione al minuto per 24 ore = 1440 campioni
            const numSamples = 1440; 
            const buffer = new ArrayBuffer(12 + numSamples * 10);
            const view = new DataView(buffer);
            
            let offset = 0;
            // Header
            view.setUint32(offset, 0x474F4C54, true); offset += 4; // Magic "TLOG"
            view.setUint8(offset, 1); offset += 1; // Version
            view.setUint16(offset, year, true); offset += 2;
            view.setUint8(offset, month); offset += 1;
            view.setUint8(offset, day); offset += 1;
            view.setUint16(offset, numSamples, true); offset += 2;
            view.setUint8(offset, 0); offset += 1; // Reserved
            
            // Data Payload
            for (let i = 0; i < numSamples; i++) {
                const minuteOfDay = i;
                // Simula una curva di temperatura sinusoidale
                const hour = i / 60;
                const tempBase = 18 + Math.sin((hour - 6) * Math.PI / 12) * 3; // Min alle 6, Max alle 18
                const noise = (Math.random() - 0.5) * 0.2;
                const temp = tempBase + noise;
                
                const setpoint = (hour >= 6 && hour <= 22) ? 21.0 : 17.0;
                const heat = temp < (setpoint - 0.2) ? 1 : 0; // Isteresi semplice
                
                view.setUint16(offset, minuteOfDay, true); offset += 2;
                view.setInt16(offset, Math.round(temp * 100), true); offset += 2;
                view.setUint8(offset, 50 + Math.random() * 5); offset += 1; // Hum 50-55%
                view.setUint8(offset, heat); offset += 1; // Flags (bit 0 = heat)
                view.setInt16(offset, Math.round(setpoint * 100), true); offset += 2;
                view.setUint8(offset, 1); offset += 1; // Active Bank
                view.setUint8(offset, 0); offset += 1; // Reserved
            }
            
            return buffer;
        }

        function parseBinaryLog(arrayBuffer) {
            const view = new DataView(arrayBuffer);
            let offset = 0;

            // Leggi header (12 bytes)
            const magic = view.getUint32(offset, true); offset += 4;
            const version = view.getUint8(offset); offset += 1;
            const year = view.getUint16(offset, true); offset += 2;
            const month = view.getUint8(offset); offset += 1;
            const day = view.getUint8(offset); offset += 1;
            const numSamples = view.getUint16(offset, true); offset += 2;
            const reserved = view.getUint8(offset); offset += 1;

            // Verifica magic number
            if (magic !== 0x474F4C54) { // "TLOG"
                throw new Error('File non valido (magic number errato)');
            }

            console.log(`Log file: ${year}-${String(month).padStart(2,'0')}-${String(day).padStart(2,'0')}, ${numSamples} samples`);

            // Leggi records (10 bytes ciascuno - formato history_sample_t)
            const data = [];
            const downsample = 5; // Campiona 1 ogni 5 minuti per ridurre punti

            for (let i = 0; i < numSamples; i++) {
                const minuteOfDay = view.getUint16(offset, true); offset += 2;
                const temp = view.getInt16(offset, true); offset += 2;
                const hum = view.getUint8(offset); offset += 1;
                const flags = view.getUint8(offset); offset += 1;
                const setpoint = view.getInt16(offset, true); offset += 2;
                const activeBank = view.getUint8(offset); offset += 1;
                const res = view.getUint8(offset); offset += 1;

                // Estrai flag caldaia (bit 0)
                const heat = flags & 0x01;

                // Campiona solo 1 ogni N
                if (i % downsample === 0) {
                    const hour = Math.floor(minuteOfDay / 60);
                    const minute = minuteOfDay % 60;

                    // Converti sentinel values a null per Chart.js
                    const temp_value = (temp === -32768) ? null : temp / 100.0;
                    const setpoint_value = (setpoint === -32768) ? null : setpoint / 100.0;
                    const hum_value = (hum === 255) ? null : hum;

                    data.push({
                        t: `${String(hour).padStart(2,'0')}:${String(minute).padStart(2,'0')}`,
                        temp: temp_value,
                        hum: hum_value,
                        heat: heat,
                        setpoint: setpoint_value
                    });
                }
            }

            return {
                date: `${year}-${String(month).padStart(2,'0')}-${String(day).padStart(2,'0')}`,
                samples: numSamples,
                data: data
            };
        }

        function processData(data) {
            const labels = data.data.map(d => d.t);
            const temperatures = data.data.map(d => d.temp);
            const humidity = data.data.map(d => d.hum);
            const heaterStates = data.data.map(d => d.heat);
            const setpoints = data.data.map(d => d.setpoint);

            // Crea/aggiorna grafico
            const ctx = document.getElementById('temperatureChart').getContext('2d');

            if (chart) {
                chart.destroy();
            }

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Temperatura',
                        data: temperatures,
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        yAxisID: 'y',
                        fill: true,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        pointHitRadius: 10
                    }, {
                        label: 'Umidit√†',
                        data: humidity,
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        yAxisID: 'y1',
                        fill: true,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        pointHitRadius: 10
                    }, {
                        label: 'Soglia',
                        data: setpoints,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        tension: 0,
                        yAxisID: 'y',
                        fill: false,
                        pointRadius: 0,
                        pointHoverRadius: 0
                    }, {
                        label: 'Caldaia',
                        data: heaterStates.map(h => h * 30), // Scala per visibilit√†
                        borderColor: 'rgb(255, 159, 64)',
                        backgroundColor: 'rgba(255, 159, 64, 0.3)',
                        borderWidth: 1,
                        stepped: 'before',
                        yAxisID: 'y',
                        fill: true,
                        pointRadius: 0,
                        pointHoverRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    // Interazione migliorata
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: `Dati del ${data.date}`,
                            font: { size: 16 }
                        },
                        // CONFIGURAZIONE TOOLTIP ESTERNO (LEGENDA FISSA)
                        tooltip: {
                            enabled: false, // Disabilita tooltip interno
                            external: function(context) {
                                const tooltipEl = document.getElementById('chart-tooltip');
                                const tooltipModel = context.tooltip;

                                // Nascondi se il mouse esce
                                if (tooltipModel.opacity === 0) {
                                    tooltipEl.style.opacity = 0;
                                    return;
                                }

                                let innerHtml = '';
                                
                                // Intestazione (Orario)
                                if (tooltipModel.title) {
                                    innerHtml += `<div class="tooltip-header">Ore ${tooltipModel.title[0]}</div>`;
                                }

                                // Corpo (Dati)
                                if (tooltipModel.body) {
                                    const bodyLines = tooltipModel.body.map(b => b.lines);
                                    bodyLines.forEach((body, i) => {
                                        const colors = tooltipModel.labelColors[i];
                                        const style = `background:${colors.borderColor}`;
                                        const span = `<span class="tooltip-color" style="${style}"></span>`;
                                        
                                        // Pulisci etichetta (rimuovi Label:)
                                        const text = body[0].split(':'); 
                                        const label = text[0];
                                        const value = text[1] || '';

                                        innerHtml += `
                                            <div class="tooltip-row">
                                                <div style="display:flex; align-items:center">
                                                    ${span} ${label}
                                                </div>
                                                <span style="font-weight:bold">${value}</span>
                                            </div>`;
                                    });
                                }

                                tooltipEl.innerHTML = innerHtml;
                                tooltipEl.style.opacity = 1;
                            }
                        },
                        zoom: {
                            zoom: {
                                wheel: {
                                    enabled: true,
                                    speed: 0.1
                                },
                                drag: {
                                    enabled: true,
                                    backgroundColor: 'rgba(127,127,127,0.3)',
                                    borderColor: 'rgb(127,127,127)',
                                    borderWidth: 1
                                },
                                pinch: {
                                    enabled: true
                                },
                                mode: 'x'
                            },
                            // CONFIGURAZIONE PAN
                            pan: {
                                enabled: true,
                                mode: 'x',
                                modifierKey: 'shift', // Richiede tasto Shift per il Pan
                            },
                            limits: {
                                x: {min: 'original', max: 'original'},
                                y: {min: 'original', max: 'original'},
                                y1: {min: 'original', max: 'original'}
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                maxTicksLimit: 24,
                                autoSkip: true
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Temperatura (¬∞C)'
                            },
                            min: 10,
                            max: 30
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Umidit√† (%)'
                            },
                            min: 0,
                            max: 100,
                            grid: {
                                drawOnChartArea: false,
                            }
                        }
                    }
                }
            });

            // Calcola statistiche
            updateStats(temperatures, humidity, heaterStates);

            // Previeni scroll della pagina quando si usa la rotella sul grafico
            const chartContainer = document.getElementById('chartContainer');
            chartContainer.addEventListener('wheel', function(e) {
                e.preventDefault();
            }, { passive: false });

            // Disabilita menu contestuale sul grafico (per permettere tasto destro)
            chartContainer.addEventListener('contextmenu', function(e) {
                e.preventDefault();
            });
        }

        function updateStats(temps, humidity, heater) {
            const validTemps = temps.filter(t => t !== null);
            const validHum = humidity.filter(h => h !== null);

            if (validTemps.length === 0) return;

            const avgTemp = (validTemps.reduce((a, b) => a + b, 0) / validTemps.length).toFixed(1);
            const minTemp = Math.min(...validTemps).toFixed(1);
            const maxTemp = Math.max(...validTemps).toFixed(1);
            const avgHum = (validHum.reduce((a, b) => a + b, 0) / validHum.length).toFixed(0);

            // Calcola tempo caldaia attiva
            const heaterOnCount = heater.filter(h => h === 1).length;
            const heaterOnMinutes = heaterOnCount * 5; 
            const heaterOnHours = Math.floor(heaterOnMinutes / 60);
            const heaterOnMins = heaterOnMinutes % 60;
            const heaterTimeStr = `${heaterOnHours}h ${heaterOnMins}m`;

            const statsHTML = `
                <div class="stat-card">
                    <h3>Temperatura Media</h3>
                    <div class="value">${avgTemp}¬∞C</div>
                </div>
                <div class="stat-card">
                    <h3>Temp. Min/Max</h3>
                    <div class="value">${minTemp}¬∞C / ${maxTemp}¬∞C</div>
                </div>
                <div class="stat-card">
                    <h3>Umidit√† Media</h3>
                    <div class="value">${avgHum}%</div>
                </div>
                <div class="stat-card">
                    <h3>Caldaia Attiva</h3>
                    <div class="value">${heaterTimeStr}</div>
                </div>
            `;

            document.getElementById('stats').innerHTML = statsHTML;
        }
    </script>
</body>
</html>